<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- 
    ============================================================================
    VERSÃO FINAL - NOTIFICAÇÕES PERSONALIZADAS (15/01/2026)
    ============================================================================
    FUNCIONALIDADES:
    - Interface: Modais personalizados substituindo alert() e confirm() nativos
    - Login: Busca usuários EXCLUSIVAMENTE do banco de dados
    - Segurança: Nenhuma credencial hardcoded
    - Histórico: Listas colapsáveis
    - Cadastro de Usuários: Tela exclusiva para Admin
    - Bloqueio de Scan Duplicado
    - Rondas Preventivas e Relatórios PDF
    - Banco de Dados em Nuvem (Firebase)
    ============================================================================
    -->

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#D32F2F">
    <meta name="description" content="App de Inspeção de Extintores e Hidrantes">
    
    <!-- Configurações PWA iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TR FIRE">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/785/785116.png">
    
    <!-- Manifesto PWA -->
    <link rel="manifest" id="manifest-placeholder" href="data:application/json;base64,eyJuYW1lIjoiVFIgRklSRSIsInNob3J0X25hbWUiOiJUUiBGSVJFIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNEMzJGMkYiLCJ0aGVtZV9jb2xvciI6IiNEMzJGMkYiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0IiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzc4NS83ODUxMTYucG5nIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3BuZyJ9LHsic3JjIjoiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvNzg1Lzc4NTExNi5wbmciLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn1dfQ==">

    <!-- Script de Garantia para o Nome do App -->
    <script>
        const manifestData = {
            "name": "TR FIRE",
            "short_name": "TR FIRE",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#D32F2F",
            "theme_color": "#D32F2F",
            "orientation": "portrait",
            "icons": [
                {"src": "https://cdn-icons-png.flaticon.com/512/785/785116.png", "sizes": "192x192", "type": "image/png"},
                {"src": "https://cdn-icons-png.flaticon.com/512/785/785116.png", "sizes": "512x512", "type": "image/png"}
            ]
        };
        const stringManifest = JSON.stringify(manifestData);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
    </script>

    <title>TR FIRE Inspeções</title>

    <!-- DEPENDÊNCIAS -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overscroll-behavior-y: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        input, textarea, select { font-size: 16px !important; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        #reader { width: 100%; height: 100%; overflow: hidden; background: black; }
        #reader video { object-fit: cover; width: 100% !important; height: 100% !important; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { red: '#D32F2F', orange: '#F57C00', black: '#212121', dark: '#121212', blue: '#1976D2' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-brand-dark h-screen w-full overflow-hidden text-gray-900 dark:text-gray-100">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const { useState, useEffect, useRef, useMemo } = React;
        const { jsPDF } = window.jspdf;

        // =========================================================================
        // GESTÃO DE CONFIGURAÇÃO DO FIREBASE
        // =========================================================================
        
        const hardcodedConfig = {
            apiKey: "AIzaSyCD6T_Fe-maCzrp79k1hfEEyo9iKkqLPEM",
            authDomain: "tr-fire-app-8762c.firebaseapp.com",
            projectId: "tr-fire-app-8762c",
            storageBucket: "tr-fire-app-8762c.firebasestorage.app",
            messagingSenderId: "2601619994",
            appId: "1:2601619994:web:93881f2f647d2f4624b7a3"
        };

        // Inicializa Firebase
        let dbFirestore = null;
        let app = null;

        try {
            app = initializeApp(hardcodedConfig);
            dbFirestore = getFirestore(app);
            console.log("Firebase conectado com sucesso!");
        } catch (error) {
            console.error("Erro na inicialização:", error);
        }

        // =========================================================================
        // COMPONENTES & APP
        // =========================================================================

        const LOGO_SRC = "logo.png"; 
        const FALLBACK_LOGO = "https://cdn-icons-png.flaticon.com/512/785/785116.png";
        const LOCATION_OPTIONS = ["ANJUN", "AZUL CARGO", "AREAS COMUNS", "EQ. RESERVA", "LATAM", "MELI", "POWER SOURCE", "TOTAL EXP."];
        const ROUND_LOCATIONS = ["CASA DE BOMBAS", "TANQUE DE DIESEL", "RESERVA DE INCÊNDIO", "GERADORES"];
        const ROUND_AREAS = ["G-100", "G-200", "G-300"];
        const ADMIN_USER = "THAWILLYS ROCHA"; 

        const generateUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });

        const formatDate = (dateStr) => {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleString('pt-BR', { 
                day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' 
            });
        };

        const LogoImage = ({ className }) => (
            <img 
                src={LOGO_SRC} 
                onError={(e) => {e.target.onerror = null; e.target.src=FALLBACK_LOGO}} 
                alt="Logo TR Fire" 
                className={className} 
            />
        );

        // COMPONENTE DE NOTIFICAÇÃO (MODAL)
        const NotificationModal = ({ isOpen, message, type, isConfirmation, onClose, onConfirm }) => {
            if (!isOpen) return null;
            
            const colors = {
                error: 'bg-red-500',
                success: 'bg-green-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const icon = {
                error: 'fa-times',
                success: 'fa-check',
                warning: 'fa-exclamation',
                info: 'fa-info'
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 animate-fade-in">
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-3xl w-full max-w-sm text-center shadow-2xl animate-scale-in relative border border-gray-100 dark:border-gray-700">
                        <div className={`w-20 h-20 rounded-full ${colors[type] || colors.info} flex items-center justify-center mx-auto mb-5 shadow-lg`}>
                            <i className={`fas ${icon[type] || icon.info} text-4xl text-white`}></i>
                        </div>
                        <h3 className="text-xl font-black text-gray-800 dark:text-white mb-2 uppercase">{isConfirmation ? 'Confirmação' : (type === 'error' ? 'Atenção' : 'Sucesso')}</h3>
                        <p className="text-gray-600 dark:text-gray-300 mb-8 text-base font-medium leading-relaxed whitespace-pre-line">{message}</p>
                        
                        <div className="flex gap-3 justify-center">
                            {isConfirmation && (
                                <button onClick={onClose} className="flex-1 py-3.5 rounded-xl bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-bold active:scale-95 transition-transform">Cancelar</button>
                            )}
                            <button 
                                onClick={() => {
                                    if (isConfirmation && onConfirm) onConfirm();
                                    onClose();
                                }} 
                                className={`flex-1 py-3.5 rounded-xl text-white font-bold shadow-lg active:scale-95 transition-transform ${colors[type] || colors.info}`}
                            >
                                {isConfirmation ? 'Confirmar' : 'Entendido'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // TELA DE RESPONSÁVEL
        const ResponsibleScreen = ({ onConfirm, usersList, showAlert }) => {
            const [selectedName, setSelectedName] = useState("");
            const [password, setPassword] = useState("");

            const handleLoginAttempt = () => {
                if (!selectedName || !password) return;
                const user = usersList.find(u => u.name === selectedName);
                if (user && user.pass === password) {
                    onConfirm(selectedName);
                } else {
                    showAlert("Senha incorreta. Tente novamente.", "error");
                }
            };

            return (
                <div className="flex flex-col h-full bg-brand-red p-6 items-center justify-center animate-fade-in relative">
                    <div className="w-32 h-32 mb-2 bg-white rounded-full p-4 shadow-2xl flex items-center justify-center">
                         <LogoImage className="w-full h-full object-contain" />
                    </div>
                    <h1 className="text-white text-3xl font-extrabold tracking-tight mb-1 text-center">TR FIRE <span className="text-brand-orange">INSPEÇÕES</span></h1>
                    <p className="text-white/80 text-sm mb-4 font-medium">Sistema de Controle de Equipamentos</p>
                    <div className="flex items-center gap-2 mb-6 bg-black/20 px-3 py-1 rounded-full">
                        <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                        <p className="text-white/90 text-xs font-bold">ONLINE</p>
                    </div>
                    
                    <div className="bg-white dark:bg-gray-900 p-6 rounded-2xl shadow-2xl w-full max-w-sm space-y-6">
                        <div>
                            <label className="text-sm font-bold text-gray-700 dark:text-gray-300 block mb-2">Responsável pela Inspeção *</label>
                            <div className="relative">
                                {usersList.length === 0 ? (
                                    <div className="text-center py-4 text-gray-500"><i className="fas fa-spinner fa-spin"></i> Carregando usuários...</div>
                                ) : (
                                    <select 
                                        value={selectedName} 
                                        onChange={(e) => { setSelectedName(e.target.value); setPassword(""); }} 
                                        className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 focus:border-brand-orange outline-none dark:text-white appearance-none font-bold text-gray-700"
                                    >
                                        <option value="">Selecione...</option>
                                        {usersList.map(u => <option key={u.id} value={u.name}>{u.name}</option>)}
                                    </select>
                                )}
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-700 dark:text-gray-300"><i className="fas fa-chevron-down"></i></div>
                            </div>
                        </div>

                        <div className={`transition-all duration-300 ${selectedName ? 'opacity-100 max-h-24' : 'opacity-50 max-h-24 pointer-events-none'}`}>
                            <label className="text-sm font-bold text-gray-700 dark:text-gray-300 block mb-2">Senha de Acesso *</label>
                            <div className="relative">
                                <input 
                                    type="password" 
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    placeholder="Digite sua senha..."
                                    className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 focus:border-brand-orange outline-none dark:text-white font-bold text-gray-700 placeholder-gray-400"
                                    disabled={!selectedName}
                                />
                                <div className="absolute inset-y-0 right-0 flex items-center px-4 text-gray-400">
                                    <i className="fas fa-lock"></i>
                                </div>
                            </div>
                        </div>

                        <button 
                            onClick={handleLoginAttempt} 
                            disabled={!selectedName}
                            className={`w-full py-4 rounded-xl text-xl font-bold shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 ${selectedName ? 'bg-brand-orange hover:bg-orange-600 text-white' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                        >
                            INICIAR INSPEÇÃO <i className="fas fa-arrow-right"></i>
                        </button>
                    </div>

                    <div className="absolute bottom-4 w-full text-center space-y-2">
                        <div className="text-white/90 text-xs text-center mb-1 leading-relaxed font-medium">
                            <p>Copyright © 2026 Fire Personality ME</p>
                            <p>Todos os direitos reservados</p>
                            <p>(Thawillys Rocha)</p>
                        </div>
                        <p className="text-white/40 text-xs">Versão Beta 1.5</p>
                    </div>
                </div>
            );
        };

        const UserRegisterScreen = ({ onNavigate, onSaveUser, usersList, onUpdateUser, onDeleteUser, showAlert, showConfirm }) => {
            const [newUser, setNewUser] = useState({ name: '', pass: '' });
            const [saving, setSaving] = useState(false);
            const [showList, setShowList] = useState(false);

            const handleSave = async () => {
                if (!newUser.name || !newUser.pass) return showAlert("Preencha nome e senha.", "warning");
                setSaving(true);
                await onSaveUser({
                    name: newUser.name.toUpperCase(),
                    pass: newUser.pass
                });
                setSaving(false);
                showAlert("Usuário cadastrado com sucesso!", "success");
                setNewUser({ name: '', pass: '' });
            };

            const handleDeleteAttempt = (id) => {
                showConfirm("Tem certeza que deseja excluir este usuário permanentemente?", () => onDeleteUser(id), "error");
            };

            return (
                <div className="flex flex-col h-full bg-white dark:bg-brand-dark p-6 animate-fade-in relative overflow-y-auto">
                    <div className="absolute top-4 left-4">
                        <button onClick={() => onNavigate('menu')} className="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-600 dark:text-white shadow-sm"><i className="fas fa-arrow-left"></i></button>
                    </div>
                    
                    <div className="mt-16 text-center mb-8">
                        <div className="inline-flex items-center justify-center w-16 h-16 bg-brand-orange rounded-full mb-4">
                            <i className="fas fa-user-plus text-2xl text-white"></i>
                        </div>
                        <h2 className="text-2xl font-black text-gray-800 dark:text-white uppercase">NOVO USUÁRIO</h2>
                        <p className="text-gray-500 dark:text-gray-400 text-sm">Cadastrar inspetor</p>
                    </div>

                    <div className="space-y-4">
                        <div>
                            <label className="text-sm font-bold text-gray-700 dark:text-gray-300 block mb-2">Nome Completo</label>
                            <input 
                                value={newUser.name}
                                onChange={e => setNewUser({...newUser, name: e.target.value})}
                                placeholder="EX: JOÃO SILVA"
                                className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 focus:border-brand-orange outline-none dark:text-white font-bold text-gray-700 uppercase"
                            />
                        </div>
                        <div>
                            <label className="text-sm font-bold text-gray-700 dark:text-gray-300 block mb-2">Senha</label>
                            <input 
                                value={newUser.pass}
                                onChange={e => setNewUser({...newUser, pass: e.target.value})}
                                placeholder="Senha de acesso"
                                type="text"
                                className="w-full p-4 bg-gray-100 dark:bg-gray-800 rounded-xl border-2 border-gray-200 dark:border-gray-700 focus:border-brand-orange outline-none dark:text-white font-bold text-gray-700"
                            />
                        </div>
                        <button 
                            onClick={handleSave}
                            disabled={saving}
                            className="w-full py-4 bg-brand-orange text-white rounded-xl text-lg font-bold shadow-lg mt-6 active:scale-95 transition-transform"
                        >
                            {saving ? 'SALVANDO...' : 'CADASTRAR'}
                        </button>
                    </div>

                    <div className="mt-8 border-t border-gray-200 dark:border-gray-700 pt-6">
                        <button 
                            onClick={() => setShowList(!showList)} 
                            className="w-full flex justify-between items-center text-gray-600 dark:text-gray-300 font-bold bg-gray-100 dark:bg-gray-800 p-4 rounded-xl"
                        >
                            <span><i className="fas fa-users mr-2"></i> Usuários Cadastrados ({usersList.length})</span>
                            <i className={`fas fa-chevron-${showList ? 'up' : 'down'}`}></i>
                        </button>
                        
                        {showList && (
                            <div className="mt-4 space-y-3">
                                {usersList.map(u => (
                                    <div key={u.id} className="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 p-4 rounded-xl flex items-center justify-between shadow-sm">
                                        <div className="flex flex-col">
                                            <span className="font-bold text-gray-800 dark:text-white text-sm">{u.name}</span>
                                            <span className="text-xs text-gray-400">Senha: {u.pass}</span>
                                        </div>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={() => {
                                                    const newPass = prompt(`Nova senha para ${u.name}:`, u.pass);
                                                    if(newPass && newPass !== u.pass) onUpdateUser(u.id, newPass);
                                                }} 
                                                className="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center hover:bg-blue-200"
                                                title="Alterar Senha"
                                            >
                                                <i className="fas fa-key text-xs"></i>
                                            </button>
                                            <button 
                                                onClick={() => handleDeleteAttempt(u.id)} 
                                                className="w-8 h-8 rounded-full bg-red-100 text-red-600 flex items-center justify-center hover:bg-red-200"
                                                title="Excluir Usuário"
                                            >
                                                <i className="fas fa-trash text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const MenuScreen = ({ onNavigate, responsibleName, onStartInspection }) => {
            const [time, setTime] = useState(new Date());

            const isAdmin = responsibleName === ADMIN_USER;

            useEffect(() => { 
                const t = setInterval(() => setTime(new Date()), 1000); 
                return () => clearInterval(t); 
            }, []);

            const handleLogout = () => {
                localStorage.removeItem('trfire_user');
                window.location.reload();
            };

            return (
                <div className="flex flex-col h-full bg-white dark:bg-brand-dark p-6 animate-fade-in relative">
                    <div className="absolute top-0 left-0 w-full bg-gray-100 dark:bg-gray-800 p-2 px-6 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                        <span>Olá, <b>{responsibleName}</b></span>
                        <button onClick={handleLogout} className="text-brand-red font-bold">Sair</button>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center space-y-6 mt-6 overflow-y-auto">
                        <div className="w-32 h-32 shrink-0">
                            <LogoImage className="w-full h-full object-contain filter drop-shadow-xl" />
                        </div>
                        <div className="text-center">
                            <h1 className="text-2xl font-extrabold tracking-tight">TR FIRE <span className="text-brand-orange">INSPEÇÕES</span></h1>
                            <p className="text-gray-500 mt-1 font-mono text-xs">
                                {time.toLocaleDateString('pt-BR', {weekday: 'long', day:'numeric', month:'long'})}<br/>
                                {time.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}
                            </p>
                        </div>

                        <div className="text-center w-full -mb-2">
                            <h2 className="text-base font-black text-gray-800 dark:text-white uppercase tracking-wider mb-1">MENU PRINCIPAL</h2>
                            <p className="text-xs text-gray-500 dark:text-gray-400 font-medium">Selecione uma categoria</p>
                        </div>

                        <div className="w-full space-y-3 pb-4">
                            {isAdmin && (
                                <button onClick={() => onNavigate('roundsLocation')} className="w-full py-4 bg-brand-blue active:bg-blue-800 text-white rounded-xl text-lg font-bold shadow-lg flex items-center justify-center gap-4 transition-transform active:scale-95 relative overflow-hidden">
                                    <div className="absolute top-0 right-0 bg-white/20 px-2 py-0.5 text-[10px] rounded-bl">Admin</div>
                                    <i className="fas fa-clipboard-check text-2xl"></i> RONDAS PREV.
                                </button>
                            )}
                            <button onClick={() => onStartInspection('EXTINTOR')} className="w-full py-4 bg-brand-red active:bg-red-800 text-white rounded-xl text-lg font-bold shadow-lg flex items-center justify-center gap-4 transition-transform active:scale-95">
                                <i className="fas fa-fire-extinguisher text-2xl"></i> EXTINTORES
                            </button>
                            <button onClick={() => onStartInspection('HIDRANTE')} className="w-full py-4 bg-brand-orange active:bg-orange-800 text-white rounded-xl text-lg font-bold shadow-lg flex items-center justify-center gap-4 transition-transform active:scale-95">
                                <i className="fas fa-faucet text-2xl"></i> HIDRANTES
                            </button>
                            <button onClick={() => onNavigate('list')} className="w-full py-4 bg-gray-800 active:bg-gray-900 text-white rounded-xl text-lg font-bold shadow-lg flex items-center justify-center gap-4 transition-transform active:scale-95">
                                <i className="fas fa-database text-xl"></i> HISTÓRICO
                            </button>
                            
                            {isAdmin && (
                                <button onClick={() => onNavigate('userRegister')} className="w-full py-4 bg-gray-700 active:bg-gray-900 text-white rounded-xl text-lg font-bold shadow-lg flex items-center justify-center gap-4 transition-transform active:scale-95 relative overflow-hidden">
                                    <div className="absolute top-0 right-0 bg-white/20 px-2 py-0.5 text-[10px] rounded-bl">Admin</div>
                                    <i className="fas fa-user-plus text-xl"></i> CADASTRAR USUÁRIO
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const RoundsLocationScreen = ({ onNavigate, onSelectLocation }) => {
            return (
                <div className="flex flex-col h-full bg-white dark:bg-brand-dark p-6 animate-fade-in relative">
                    <div className="absolute top-4 left-4">
                        <button onClick={() => onNavigate('menu')} className="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-600 dark:text-white shadow-sm"><i className="fas fa-arrow-left"></i></button>
                    </div>
                    
                    <div className="mt-16 text-center mb-8">
                        <div className="inline-flex items-center justify-center w-16 h-16 bg-blue-100 dark:bg-blue-900 rounded-full mb-4">
                            <i className="fas fa-map-marker-alt text-2xl text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <h2 className="text-2xl font-black text-gray-800 dark:text-white uppercase">LOCAIS DE RONDA</h2>
                        <p className="text-gray-500 dark:text-gray-400 text-sm">Selecione o local para iniciar</p>
                    </div>

                    <div className="flex-1 overflow-y-auto space-y-3 pb-6">
                        {ROUND_LOCATIONS.map(loc => (
                            <button 
                                key={loc} 
                                onClick={() => onSelectLocation(loc)} 
                                className="w-full py-5 bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-500 text-gray-700 dark:text-white rounded-2xl text-lg font-bold shadow-sm flex items-center justify-between px-6 transition-all active:scale-95 group"
                            >
                                <span>{loc}</span>
                                <i className="fas fa-chevron-right text-gray-300 group-hover:text-blue-500"></i>
                            </button>
                        ))}
                    </div>
                </div>
            )
        };

        const ScannerScreen = ({ onNavigate, onScanSuccess, db, inspectionType, showAlert }) => {
            const scannerRef = useRef(null);

            useEffect(() => {
                const scanner = new Html5Qrcode("reader");
                scannerRef.current = scanner;
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                scanner.start(
                    { facingMode: "environment" }, 
                    config,
                    (decodedText) => {
                        scanner.stop().then(() => {
                            scanner.clear();
                            
                            let data = { equipmentId: decodedText, equipmentName: decodedText };
                            try {
                                const parsed = JSON.parse(decodedText);
                                if(parsed.id || parsed.equipmentId) {
                                    data.equipmentId = parsed.id || parsed.equipmentId;
                                    data.equipmentName = parsed.name || parsed.equipmentName || decodedText;
                                }
                            } catch(e) {}

                            if (inspectionType !== 'RONDA') {
                                const currentMonth = new Date().toISOString().slice(0, 7); 
                                const isDuplicate = db.some(item => {
                                    if (item.deleted) return false;
                                    const scannedId = data.equipmentId.toString();
                                    const itemId = (item.equipmentId || '').toString();
                                    return scannedId === itemId && item.created_at.startsWith(currentMonth);
                                });

                                if (isDuplicate) {
                                    showAlert(`⚠️ EQUIPAMENTO JÁ VISTORIADO!\n\nEste código já foi registrado em ${new Date().toLocaleString('pt-BR', { month: 'long' })}.\nNova leitura permitida apenas no mês seguinte.`, "warning");
                                    onNavigate('menu');
                                    return; 
                                }
                            }
                            onScanSuccess(data);

                        }).catch(err => console.error(err));
                    },
                    (errorMessage) => {}
                ).catch(err => console.error(err));

                return () => {
                    if (scanner.isScanning) scanner.stop().then(() => scanner.clear()).catch(() => {});
                    else try { scanner.clear(); } catch(e) {}
                };
            }, [db, inspectionType]);

            return (
                <div className="flex flex-col h-full bg-black relative">
                    <div className="absolute top-4 left-4 z-20">
                        <button onClick={() => onNavigate('menu')} className="text-white bg-black/40 w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-sm"><i className="fas fa-arrow-left"></i></button>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-center bg-gray-900">
                        <div id="reader" className="w-full max-w-md bg-black"></div>
                        <p className="text-white/60 text-sm mt-4">Aponte para o QR Code</p>
                    </div>
                    <div className="p-6 bg-white dark:bg-brand-dark rounded-t-3xl z-10 safe-area-bottom">
                        <button onClick={() => {
                            const manualId = prompt("Digite o ID do equipamento:");
                            if(!manualId) return;
                            
                            let data = { equipmentId: manualId, equipmentName: manualId };
                            
                            if (inspectionType !== 'RONDA') {
                                const currentMonth = new Date().toISOString().slice(0, 7);
                                const isDuplicate = db.some(item => 
                                    !item.deleted && 
                                    (item.equipmentId || '').toString() === manualId && 
                                    item.created_at.startsWith(currentMonth)
                                );
                                if (isDuplicate) {
                                    showAlert("⚠️ EQUIPAMENTO JÁ VISTORIADO!\nRegistro duplicado no mês atual.", "warning");
                                    return;
                                }
                            }
                            onScanSuccess(data);
                        }} className="w-full py-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white font-bold rounded-xl flex items-center justify-center gap-2"><i className="fas fa-keyboard"></i> Digitar Manualmente</button>
                    </div>
                </div>
            );
        };

        const RoundsFormScreen = ({ initialData, onNavigate, onSave, responsibleName, roundLocation, showAlert }) => {
            const [isSaving, setIsSaving] = useState(false);
            const [form, setForm] = useState({
                type: 'RONDA',
                sector: roundLocation,
                equipmentName: initialData?.equipmentName || '', // Campo Área Técnica
                moduleLocation: '', // Galpão/Local
                status: '', // Conforme/Não Conforme
                photo: null,
                obs: '',
                responsible: responsibleName,
                created_at: new Date().toISOString(),
                deleted: false
            });

            const fileInputRef = useRef(null);

            const handlePhotoChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            // Redimensionar para max 600px para economizar espaço
                            const MAX_WIDTH = 600;
                            const MAX_HEIGHT = 600;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                            } else {
                                if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.6); // Qualidade média
                            setForm(prev => ({ ...prev, photo: dataUrl }));
                        }
                        img.src = event.target.result;
                    }
                    reader.readAsDataURL(file);
                }
            };

            const save = async () => {
                if (!form.equipmentName || !form.moduleLocation || !form.status) {
                    return showAlert("Preencha todos os campos obrigatórios (*)", "warning");
                }
                if (!form.photo) {
                    return showAlert("⚠️ O registro fotográfico é OBRIGATÓRIO antes de salvar.", "warning");
                }

                setIsSaving(true);
                await onSave(form);
                setIsSaving(false);
            };

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-black">
                    <div className="bg-white dark:bg-gray-900 p-4 shadow-sm flex items-center justify-between sticky top-0 z-20">
                        <div className="flex flex-col">
                            <div className="flex items-center">
                                <button onClick={() => onNavigate('roundsLocation')} className="w-8 h-8 flex items-center justify-center text-gray-600 dark:text-white mr-2"><i className="fas fa-arrow-left"></i></button>
                                <h2 className="text-lg font-bold text-gray-800 dark:text-white">Ronda Preventiva</h2>
                            </div>
                            <span className="text-xs text-gray-500 ml-10">Local: <b>{roundLocation}</b></span>
                        </div>
                        <button onClick={save} disabled={isSaving} className="bg-brand-blue text-white px-4 py-2 rounded-lg font-bold shadow-sm active:scale-95 transition-transform text-sm flex items-center">
                            {isSaving ? <i className="fas fa-spinner fa-spin mr-2"></i> : <i className="fas fa-save mr-2"></i>} 
                            {isSaving ? 'SALVANDO' : 'SALVAR'}
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-900">
                            <label className="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase">Área Técnica (QR Code)</label>
                            <input 
                                value={form.equipmentName} 
                                onChange={e=>setForm({...form, equipmentName:e.target.value})} 
                                placeholder="Escaneie ou digite..." 
                                className="w-full bg-transparent font-bold text-lg border-b border-blue-300 focus:outline-none py-1 dark:text-white"
                            />
                        </div>

                        <div className="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm space-y-4">
                            <div>
                                <label className="text-xs text-gray-500 font-bold block mb-1">Galpão/Local *</label>
                                <div className="relative">
                                    <select 
                                        value={form.moduleLocation} 
                                        onChange={e=>setForm({...form, moduleLocation:e.target.value})} 
                                        className="w-full p-3 bg-gray-100 dark:bg-gray-700 rounded-lg font-bold dark:text-white appearance-none"
                                    >
                                        <option value="">Selecione...</option>
                                        {ROUND_AREAS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                    </select>
                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500"><i className="fas fa-chevron-down"></i></div>
                                </div>
                            </div>

                            <div>
                                <label className="text-xs text-gray-500 font-bold block mb-1">Status *</label>
                                <div className="relative">
                                    <select 
                                        value={form.status} 
                                        onChange={e=>setForm({...form, status:e.target.value})} 
                                        className={`w-full p-3 rounded-lg font-bold appearance-none ${
                                            form.status === 'Conforme' ? 'bg-green-100 text-green-700' : 
                                            form.status === 'Não Conforme' ? 'bg-red-100 text-red-700' : 'bg-gray-100 dark:bg-gray-700 dark:text-white'
                                        }`}
                                    >
                                        <option value="">Selecione...</option>
                                        <option value="Conforme">Conforme</option>
                                        <option value="Não Conforme">Não Conforme</option>
                                    </select>
                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500"><i className="fas fa-chevron-down"></i></div>
                                </div>
                            </div>
                        </div>

                        {/* REGISTRO FOTOGRÁFICO - OBRIGATÓRIO */}
                        <div className={`bg-white dark:bg-gray-800 p-4 rounded-xl border ${!form.photo ? 'border-red-300 dark:border-red-900/50' : 'border-gray-100 dark:border-gray-700'} shadow-sm transition-colors`}>
                            <label className={`text-xs font-bold block mb-2 uppercase ${!form.photo ? 'text-red-500' : 'text-gray-500'}`}>Registro Fotográfico { !form.photo && '(Obrigatório)'}</label>
                            
                            {!form.photo ? (
                                <div 
                                    onClick={() => fileInputRef.current.click()}
                                    className="w-full h-32 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                                >
                                    <i className="fas fa-camera text-2xl mb-2"></i>
                                    <span className="text-sm font-medium">Tirar Foto (Horizontal)</span>
                                </div>
                            ) : (
                                <div className="relative w-full rounded-lg overflow-hidden border border-gray-200 dark:border-gray-600">
                                    <img src={form.photo} alt="Registro" className="w-full h-auto object-cover max-h-48" />
                                    <button 
                                        onClick={() => setForm({...form, photo: null})}
                                        className="absolute top-2 right-2 w-8 h-8 bg-red-600 text-white rounded-full flex items-center justify-center shadow-md active:scale-90"
                                    >
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>
                            )}
                            <input 
                                type="file" 
                                ref={fileInputRef} 
                                accept="image/*" 
                                capture="environment" 
                                onChange={handlePhotoChange} 
                                className="hidden" 
                            />
                        </div>

                        <textarea value={form.obs} onChange={e=>setForm({...form, obs:e.target.value})} placeholder="Observações (Opcional)..." className="w-full p-4 rounded-xl border-none shadow-sm h-32 resize-none bg-white dark:bg-gray-800 dark:text-white mb-4"></textarea>
                    </div>
                </div>
            );
        };

        const FormScreen = ({ initialData, onNavigate, onSave, responsibleName, inspectionType, showAlert }) => {
            const [isSaving, setIsSaving] = useState(false);
            const [form, setForm] = useState({
                type: inspectionType,
                equipmentId: initialData?.equipmentId || '',
                equipmentName: initialData?.equipmentName || '',
                moduleLocation: '', 
                hasId: null, 
                floorSign: null, 
                q1: null, 
                q2: null, 
                nextRecharge: '', 
                h_complete: null, h_unobstructed: null, h_seal_broken: null,
                nextHydro: '', obs: '', responsible: responsibleName, 
                created_at: new Date().toISOString(),
                deleted: false 
            });

            const save = async () => {
                let required = false;
                if (!form.equipmentId || !form.moduleLocation) required = true;

                if (inspectionType === 'EXTINTOR') {
                    if (form.q1 === null || form.q2 === null || form.hasId === null || form.floorSign === null || !form.nextRecharge || !form.nextHydro) required = true;
                } else {
                    if (form.h_complete === null || form.h_unobstructed === null || form.h_seal_broken === null || !form.nextHydro) required = true;
                }
                
                if(required) return showAlert("Preencha todos os campos obrigatórios (*)", "warning");
                
                setIsSaving(true);
                await onSave(form);
                setIsSaving(false);
            };

            const handleDateInput = (v) => {
                v = v.replace(/\D/g, ''); 
                if (v.length > 6) v = v.slice(0, 6); 
                if (v.length >= 2) return v.slice(0, 2) + '/' + v.slice(2);
                return v;
            };

            const ColorSelect = ({ label, val, field, invert=false }) => {
                let bgClass = "bg-white dark:bg-gray-800";
                let textClass = "text-gray-700 dark:text-gray-200";
                if(val === true) {
                    bgClass = invert ? "bg-red-100 dark:bg-red-900 border-red-500" : "bg-green-100 dark:bg-green-900 border-green-500";
                    textClass = invert ? "text-red-700 dark:text-red-100" : "text-green-700 dark:text-green-100";
                } else if(val === false) {
                    bgClass = invert ? "bg-green-100 dark:bg-green-900 border-green-500" : "bg-red-100 dark:bg-red-900 border-red-500";
                    textClass = invert ? "text-green-700 dark:text-green-100" : "text-red-700 dark:text-red-100";
                }
                return (
                    <div className={`p-3 rounded-xl border ${val !== null ? 'border-2' : 'border-gray-200 dark:border-gray-700'} ${bgClass} shadow-sm transition-colors`}>
                        <p className={`font-bold mb-1 text-xs ${val !== null ? textClass : 'text-gray-500 dark:text-gray-400'}`}>{label} *</p>
                        <select value={val === null ? '' : (val ? 'true' : 'false')} onChange={(e) => { const v = e.target.value; setForm({...form, [field]: v === '' ? null : (v === 'true')}); }} className={`w-full bg-transparent font-bold focus:outline-none ${textClass} appearance-none`}>
                            <option value="">Selecionar...</option><option value="true">Sim</option><option value="false">Não</option>
                        </select>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-black">
                    <div className="bg-white dark:bg-gray-900 p-4 shadow-sm flex items-center justify-between sticky top-0 z-20">
                        <div className="flex flex-col">
                            <div className="flex items-center">
                                <button onClick={() => onNavigate('menu')} className="w-8 h-8 flex items-center justify-center text-gray-600 dark:text-white mr-2"><i className="fas fa-arrow-left"></i></button>
                                <h2 className="text-lg font-bold text-gray-800 dark:text-white">{inspectionType === 'HIDRANTE' ? 'Insp. Hidrante' : 'Insp. Extintor'}</h2>
                            </div>
                            <span className="text-xs text-gray-500 ml-10">Resp: <b>{responsibleName}</b></span>
                        </div>
                        <button onClick={save} disabled={isSaving} className="bg-brand-red text-white px-4 py-2 rounded-lg font-bold shadow-sm active:scale-95 transition-transform text-sm flex items-center">
                            {isSaving ? <i className="fas fa-spinner fa-spin mr-2"></i> : <i className="fas fa-save mr-2"></i>} 
                            {isSaving ? 'SALVANDO...' : 'SALVAR'}
                        </button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl border border-blue-100 dark:border-blue-900">
                            <label className="text-xs font-bold text-blue-600 dark:text-blue-400 uppercase">Equipamento</label>
                            <input value={form.equipmentId} onChange={e=>setForm({...form, equipmentId:e.target.value})} placeholder="ID do Equipamento" className="w-full bg-transparent font-mono font-bold text-lg border-b border-blue-300 focus:outline-none py-1 dark:text-white"/>
                            <input value={form.equipmentName} onChange={e=>setForm({...form, equipmentName:e.target.value})} placeholder="Nome / Descrição" className="w-full bg-transparent text-sm mt-2 focus:outline-none dark:text-gray-300"/>
                        </div>

                        <div className="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm">
                            <label className="text-xs text-gray-500 block mb-1 font-bold">Módulo/Local *</label>
                            <div className="relative">
                                <select 
                                    value={form.moduleLocation} 
                                    onChange={e=>setForm({...form, moduleLocation:e.target.value})} 
                                    className="w-full bg-transparent font-bold dark:text-white focus:outline-none appearance-none"
                                >
                                    <option value="">Selecione o local...</option>
                                    {LOCATION_OPTIONS.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center text-gray-500"><i className="fas fa-chevron-down"></i></div>
                            </div>
                        </div>

                        {inspectionType === 'EXTINTOR' ? (
                            <>
                                <div className="grid grid-cols-2 gap-3"> 
                                    <ColorSelect label="Placa de Sinalização?" field="hasId" val={form.hasId} />
                                    <ColorSelect label="Sinalização de Solo?" field="floorSign" val={form.floorSign} />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <ColorSelect label="3. Violação no Lacre?" field="q1" val={form.q1} invert={true} />
                                    <ColorSelect label="4. Obstruído?" field="q2" val={form.q2} invert={true} />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                                        <label className="text-xs text-gray-500 block mb-1">Próx. Recarga *</label>
                                        <input type="tel" value={form.nextRecharge} onChange={e=>setForm({...form, nextRecharge: handleDateInput(e.target.value)})} placeholder="Ex: 12/2026" className="w-full bg-transparent font-bold dark:text-white"/>
                                    </div>
                                    <div className="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                                        <label className="text-xs text-gray-500 block mb-1">Teste Hidro. *</label>
                                        <input type="tel" value={form.nextHydro} onChange={e=>setForm({...form, nextHydro: handleDateInput(e.target.value)})} placeholder="Ex: 12/2026" className="w-full bg-transparent font-bold dark:text-white"/>
                                    </div>
                                </div>
                            </>
                        ) : (
                            <>
                                <div className="grid grid-cols-2 gap-3">
                                    <ColorSelect label="1. Equip. Completo?" field="h_complete" val={form.h_complete} />
                                    <ColorSelect label="2. Equip. Desobstruído?" field="h_unobstructed" val={form.h_unobstructed} />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="bg-white dark:bg-gray-800 p-3 rounded-xl border border-gray-100 dark:border-gray-700">
                                        <label className="text-xs text-gray-500 block mb-1">3. Próx. Teste Hidro. *</label>
                                        <input type="tel" value={form.nextHydro} onChange={e=>setForm({...form, nextHydro: handleDateInput(e.target.value)})} placeholder="Ex: 12/2026" className="w-full bg-transparent font-bold dark:text-white"/>
                                    </div>
                                    <ColorSelect label="4. Lacre Rompido?" field="h_seal_broken" val={form.h_seal_broken} invert={true} />
                                </div>
                            </>
                        )}
                        <textarea value={form.obs} onChange={e=>setForm({...form, obs:e.target.value})} placeholder="Observações (Opcional)..." className="w-full p-4 rounded-xl border-none shadow-sm h-32 resize-none bg-white dark:bg-gray-800 dark:text-white mb-4"></textarea>
                    </div>
                </div>
            );
        };

        const ListScreen = ({ data, onNavigate, onToggleDelete, onDeletePermanently, onImportData, currentUser, showAlert, showConfirm }) => {
            const [showFilter, setShowFilter] = useState(false);
            const [showPdfModal, setShowPdfModal] = useState(false); 
            const [showBackupModal, setShowBackupModal] = useState(false);
            const [showBin, setShowBin] = useState(false);
            const [filters, setFilters] = useState({ startDate: '', endDate: '', type: '', responsible: '', moduleLocation: '' });
            const [expandedSections, setExpandedSections] = useState({}); 
            
            const fileInputRef = useRef(null);
            
            const [viewMonth, setViewMonth] = useState(new Date().toISOString().slice(0, 7));

            const isAdmin = currentUser === ADMIN_USER;

            const toggleSection = (section) => {
                setExpandedSections(prev => ({
                    ...prev,
                    [section]: !prev[section]
                }));
            };

            const responsibles = useMemo(() => [...new Set(data.map(item => item.responsible).filter(Boolean))], [data]);

            const availableMonths = useMemo(() => {
                const months = new Set(data.filter(i => i.created_at).map(item => item.created_at.slice(0, 7)));
                months.add(new Date().toISOString().slice(0, 7));
                return Array.from(months).sort().reverse(); 
            }, [data]);

            const formatMonthDisplay = (yyyy_mm) => {
                if(!yyyy_mm) return "";
                const [year, month] = yyyy_mm.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            };

            const deletedData = data.filter(item => item.deleted).sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
            
            const activeData = data.filter(item => {
                if (item.deleted) return false;
                if (!item.created_at) return false;
                
                if (item.created_at.slice(0, 7) !== viewMonth) return false;

                const itemDate = new Date(item.created_at).setHours(0,0,0,0);
                const start = filters.startDate ? new Date(filters.startDate).setHours(0,0,0,0) : null;
                const end = filters.endDate ? new Date(filters.endDate).setHours(23,59,59,999) : null;

                if (start && itemDate < start) return false;
                if (end && itemDate > end) return false;
                if (filters.type && (item.type || 'EXTINTOR') !== filters.type) return false;
                if (filters.responsible && item.responsible !== filters.responsible) return false;
                if (filters.moduleLocation && item.moduleLocation !== filters.moduleLocation) return false;
                
                return true;
            });

            const groupedData = useMemo(() => {
                return {
                    EXTINTOR: activeData.filter(i => (i.type || 'EXTINTOR') === 'EXTINTOR'),
                    HIDRANTE: activeData.filter(i => i.type === 'HIDRANTE'),
                    RONDA: activeData.filter(i => i.type === 'RONDA')
                };
            }, [activeData]);

            const displayList = showBin ? deletedData : activeData;

            const handleExport = () => {
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_trfire_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                setShowBackupModal(false);
            };

            const handleFileImport = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const json = JSON.parse(ev.target.result);
                        onImportData(json);
                        setShowBackupModal(false);
                    } catch(err) {
                        showAlert("Erro ao ler arquivo JSON. Verifique o formato.", "error");
                    }
                };
                reader.readAsText(file);
                e.target.value = null;
            };

            const generateSpecificPDF = async (type) => {
                setShowPdfModal(false);
                const reportData = activeData.filter(item => (item.type || (type === 'RONDA' ? '' : 'EXTINTOR')) === type);

                if(reportData.length === 0) return showAlert(`Sem dados ATIVOS de ${type} para gerar relatório neste mês.`, "warning");

                const doc = new jsPDF({ orientation: "landscape" });
                
                doc.setFillColor(243, 244, 246); 
                doc.rect(0, 0, 297, 40, 'F');
                
                doc.setTextColor(33, 33, 33);
                doc.setFontSize(22); 
                
                let title = "";
                if (type === 'EXTINTOR') title = "CHECK-LIST EXTINTORES MENSAL";
                else if (type === 'HIDRANTE') title = "CHECK-LIST HIDRANTES MENSAL";
                else if (type === 'RONDA') title = "RELATÓRIO DE RONDAS PREVENTIVAS";

                doc.text(title, 14, 25);
                
                doc.setFontSize(10); 
                doc.setTextColor(100, 100, 100); 
                doc.text(`Mês de Referência: ${formatMonthDisplay(viewMonth).toUpperCase()} | Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 35);
                
                doc.setFontSize(9);
                doc.setTextColor(33, 33, 33); 
                doc.text("Parque Logístico: AERO GRU I", 280, 28, { align: "right" });
                doc.text("Empresa: Vilella Assessoria em Segurança do Trabalho", 280, 35, { align: "right" });
                
                let body = [];
                let head = [];

                if (type === 'EXTINTOR') {
                    head = [['Módulo/Local?', 'Equipamento', 'Data/Hora', 'Resp.', 'Placa Sinal.?', 'Pint. de Solo?', 'Lacre Rompido?', 'Eq. Obstruído?', 'Próx. Recarga?', 'T. Hidro?', 'Observações']];
                    body = reportData.map(i => [
                        i.moduleLocation || '-', i.equipmentName, new Date(i.created_at).toLocaleDateString('pt-BR') + ' ' + new Date(i.created_at).toLocaleTimeString('pt-BR').slice(0,5), i.responsible || '-', i.hasId ? 'SIM' : 'NÃO', i.floorSign ? 'SIM' : 'NÃO', i.q1 ? 'SIM' : 'NÃO', i.q2 ? 'SIM' : 'NÃO', i.nextRecharge || '-', i.nextHydro || '-', i.obs || ''
                    ]);
                } else if (type === 'HIDRANTE') {
                    head = [['Módulo/Local?', 'Equipamento', 'Data/Hora', 'Resp.', 'Eq. Completo?', 'Eq. Obstruído?', 'Lacre Rompido?', 'Próx. T-Hidro', 'Observações']];
                    body = reportData.map(i => [
                        i.moduleLocation || '-', i.equipmentName, new Date(i.created_at).toLocaleDateString('pt-BR') + ' ' + new Date(i.created_at).toLocaleTimeString('pt-BR').slice(0,5), i.responsible || '-', i.h_complete ? 'SIM' : 'NÃO', i.h_unobstructed ? 'NÃO' : 'SIM', i.h_seal_broken ? 'SIM' : 'NÃO', i.nextHydro || '-', i.obs || ''
                    ]);
                } else if (type === 'RONDA') {
                    head = [['Local', 'Área Técnica', 'Data/Hora', 'Resp.', 'Galpão', 'Status', 'Obs']];
                    body = reportData.map(i => [
                        i.sector || '-',
                        i.equipmentName || '-',
                        new Date(i.created_at).toLocaleDateString('pt-BR') + ' ' + new Date(i.created_at).toLocaleTimeString('pt-BR').slice(0,5),
                        i.responsible || '-',
                        i.moduleLocation || '-',
                        i.status || '-',
                        i.obs || ''
                    ]);
                }

                doc.autoTable({ 
                    head: head, body: body, startY: 45, theme: 'grid',
                    headStyles: { fillColor: [224, 224, 224], textColor: [0, 0, 0], fontStyle: 'bold', lineWidth: 0.1, lineColor: [200, 200, 200] },
                    styles: { fontSize: 8, textColor: [50, 50, 50], lineColor: [230, 230, 230], lineWidth: 0.1 },
                    alternateRowStyles: { fillColor: [255, 255, 255] }
                });
                doc.save(`TRFIRE_Relatorio_${type}_${viewMonth}.pdf`);
            };

            const renderItem = (item) => {
                const isHid = item.type === 'HIDRANTE';
                const isRonda = item.type === 'RONDA';
                
                let statusColor = 'bg-gray-100 text-gray-700';
                let statusText = '---';

                if (isRonda) {
                    statusColor = item.status === 'Conforme' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                    statusText = item.status === 'Conforme' ? 'CONFORME' : 'NÃO CONFORME';
                } else if (isHid) {
                    statusColor = (item.h_complete && item.h_unobstructed && !item.h_seal_broken) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                    statusText = (item.h_complete && item.h_unobstructed && !item.h_seal_broken) ? 'OK' : 'IRREGULAR';
                } else {
                    statusColor = (!item.q1 && !item.q2) ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                    statusText = (!item.q1) ? 'OK' : 'VIOLADO';
                }

                return (
                    <div key={item.id} className={`p-4 rounded-xl shadow-sm border-l-4 flex justify-between items-center transition-all ${showBin ? 'bg-red-50 dark:bg-red-900/10 border-red-500 opacity-80' : 'bg-white dark:bg-gray-800 border-brand-red'}`}>
                        <div>
                            <div className="flex items-center gap-2">
                                <span className={`text-xs font-bold px-1 rounded ${isRonda ? 'bg-blue-100 text-blue-700' : 'bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300'}`}>{item.type || 'EXT'}</span>
                                <span className="font-bold text-gray-800 dark:text-white text-sm">{item.equipmentName}</span>
                            </div>
                            {isRonda && <div className="text-xs text-gray-500 font-bold mt-1">Local: {item.sector} | {item.moduleLocation}</div>}
                            <div className="text-xs text-gray-500 mt-1 flex gap-2">
                                <span><i className="far fa-clock mr-1"></i>{formatDate(item.created_at)}</span>
                                <span className="text-gray-400">| {item.responsible}</span>
                            </div>
                            {!showBin && (
                                <span className={`inline-block mt-1 text-[10px] px-2 py-0.5 rounded font-bold ${statusColor}`}>{statusText}</span>
                            )}
                            {isRonda && item.photo && (
                                <div className="mt-1">
                                    <i className="fas fa-camera text-gray-400"></i> <span className="text-[10px] text-gray-400">Foto anexada</span>
                                </div>
                            )}
                        </div>
                        <div className="flex flex-col items-end gap-2">
                            {showBin ? (
                                <div className="flex items-center gap-2">
                                    <button 
                                        onClick={() => {
                                            if (item.responsible !== currentUser) return showAlert("🚫 Ação Negada: Permitido somente pelo usuário " + item.responsible + ".", "error");
                                            onToggleDelete(item.id, false);
                                        }}
                                        className="bg-green-100 text-green-600 hover:bg-green-200 w-10 h-10 rounded-full flex items-center justify-center shadow-sm transition-all active:scale-95"
                                        title="Restaurar"
                                    >
                                        <i className="fas fa-trash-restore"></i>
                                    </button>
                                    
                                    {isAdmin && (
                                        <button 
                                            onClick={() => {
                                                showConfirm("⚠️ ATENÇÃO: Deseja excluir este registro PERMANENTEMENTE? Esta ação não pode ser desfeita.", () => onDeletePermanently(item.id), "error");
                                            }}
                                            className="bg-red-100 text-red-600 hover:bg-red-200 w-10 h-10 rounded-full flex items-center justify-center shadow-sm transition-all active:scale-95"
                                            title="Eliminar Definitivamente"
                                        >
                                            <i className="fas fa-times"></i>
                                        </button>
                                    )}
                                </div>
                            ) : (
                                <button 
                                    onClick={() => {
                                        if (item.responsible !== currentUser) return showAlert("🚫 Ação Negada: Permitido somente pelo usuário " + item.responsible + ".", "error");
                                        showConfirm("Mover para lixeira?", () => onToggleDelete(item.id, true), "warning");
                                    }}
                                    className="bg-gray-100 text-red-500 hover:bg-red-50 w-10 h-10 rounded-full flex items-center justify-center shadow-sm transition-all active:scale-95"
                                    title="Excluir"
                                >
                                    <i className="fas fa-trash"></i>
                                </button>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-black relative">
                    {/* CABEÇALHO */}
                    <div className={`${showBin ? 'bg-red-800' : 'bg-gray-900'} text-white p-4 shadow-md flex justify-between items-center sticky top-0 z-20 transition-colors duration-300`}>
                        <div className="flex items-center gap-2">
                            {showBin ? (
                                <button onClick={()=>setShowBin(false)} className="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-md flex items-center gap-2"><i className="fas fa-arrow-left"></i> VOLTAR</button>
                            ) : (
                                <button onClick={()=>onNavigate('menu')} className="bg-brand-orange hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-bold text-xs shadow-md active:scale-95 transition-all flex items-center gap-2"><i className="fas fa-plus"></i> NOVA INSPEÇÃO</button>
                            )}
                            <span className="text-xs text-white/80 hidden sm:inline ml-2">{showBin ? 'Itens Excluídos' : `${displayList.length} registros`}</span>
                        </div>
                        
                        <div className="flex gap-4 items-center">
                            {!showBin && (
                                <>
                                    <button onClick={() => setShowFilter(!showFilter)} title="Filtrar"><i className="fas fa-filter text-xl text-yellow-400"></i></button>
                                    <div className="w-px h-6 bg-gray-600 mx-1"></div>
                                    <button onClick={() => setShowPdfModal(true)} title="Gerar PDF"><i className="fas fa-file-pdf text-xl text-white"></i></button>
                                    
                                    {isAdmin && (
                                        <>
                                            <div className="w-px h-6 bg-gray-600 mx-1"></div>
                                            <button onClick={() => setShowBackupModal(true)} title="Backup / Restaurar"><i className="fas fa-cloud-upload-alt text-xl text-blue-400"></i></button>
                                        </>
                                    )}

                                    <div className="w-px h-6 bg-gray-600 mx-1"></div>
                                </>
                            )}
                            <button onClick={() => setShowBin(!showBin)} title={showBin ? "Ver Histórico" : "Ver Lixeira"} className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${showBin ? 'bg-white text-red-800' : 'bg-red-900/50 text-red-300 hover:bg-red-900 hover:text-white'}`}>
                                <i className={`fas ${showBin ? 'fa-list' : 'fa-trash'}`}></i>
                            </button>
                        </div>
                    </div>

                    {showPdfModal && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-sm animate-fade-in text-center">
                                <h3 className="text-lg font-bold mb-2 dark:text-white">Gerar Relatório</h3>
                                <p className="text-sm font-bold text-brand-red mb-6 uppercase border-b pb-2">{formatMonthDisplay(viewMonth)}</p>
                                <div className="space-y-3">
                                    <button onClick={() => generateSpecificPDF('EXTINTOR')} className="w-full py-3 bg-brand-red text-white font-bold rounded-xl shadow-md active:scale-95">Relatório de EXTINTORES</button>
                                    <button onClick={() => generateSpecificPDF('HIDRANTE')} className="w-full py-3 bg-brand-orange text-white font-bold rounded-xl shadow-md active:scale-95">Relatório de HIDRANTES</button>
                                    <button onClick={() => generateSpecificPDF('RONDA')} className="w-full py-3 bg-brand-blue text-white font-bold rounded-xl shadow-md active:scale-95">Relatório de RONDAS</button>
                                    <button onClick={() => setShowPdfModal(false)} className="w-full py-3 bg-gray-200 text-gray-700 font-bold rounded-xl mt-2">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showBackupModal && isAdmin && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                            <div className="bg-white dark:bg-gray-800 p-6 rounded-2xl w-full max-w-sm animate-fade-in text-center">
                                <h3 className="text-lg font-bold mb-4 dark:text-white flex items-center justify-center gap-2"><i className="fas fa-database text-blue-500"></i> Backup & Restauração</h3>
                                <p className="text-xs text-gray-500 mb-6">Ferramenta exclusiva para {ADMIN_USER}</p>
                                <div className="space-y-3">
                                    <button onClick={handleExport} className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md active:scale-95 flex items-center justify-center gap-2">
                                        <i className="fas fa-download"></i> EXPORTAR TUDO
                                    </button>
                                    
                                    <div className="relative">
                                        <input 
                                            type="file" 
                                            ref={fileInputRef}
                                            onChange={handleFileImport}
                                            accept=".json"
                                            className="hidden" 
                                        />
                                        <button onClick={() => fileInputRef.current.click()} className="w-full py-3 bg-green-600 text-white font-bold rounded-xl shadow-md active:scale-95 flex items-center justify-center gap-2">
                                            <i className="fas fa-upload"></i> IMPORTAR DADOS
                                        </button>
                                    </div>
                                    
                                    <button onClick={() => setShowBackupModal(false)} className="w-full py-3 bg-gray-200 text-gray-700 font-bold rounded-xl mt-4">Fechar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showFilter && !showBin && (
                        <div className="absolute top-16 right-4 z-50 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 w-64 animate-fade-in">
                            <h3 className="font-bold mb-3 dark:text-white text-sm uppercase">Filtrar por</h3>
                            <div className="space-y-3">
                                <div><label className="text-xs text-gray-500 block mb-1">De</label><input type="date" value={filters.startDate} onChange={e=>setFilters({...filters, startDate: e.target.value})} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm dark:text-white" /></div>
                                <div><label className="text-xs text-gray-500 block mb-1">Até</label><input type="date" value={filters.endDate} onChange={e=>setFilters({...filters, endDate: e.target.value})} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm dark:text-white" /></div>
                                <div><label className="text-xs text-gray-500 block mb-1">Tipo</label><select value={filters.type} onChange={e=>setFilters({...filters, type: e.target.value})} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm dark:text-white"><option value="">Todos</option><option value="EXTINTOR">Extintor</option><option value="HIDRANTE">Hidrante</option><option value="RONDA">Ronda Prev.</option></select></div>
                                <div><label className="text-xs text-gray-500 block mb-1">Responsável</label><select value={filters.responsible} onChange={e=>setFilters({...filters, responsible: e.target.value})} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm dark:text-white"><option value="">Todos</option>{responsibles.map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                                <div>
                                    <label className="text-xs text-gray-500 block mb-1">Módulo/Local</label>
                                    <select value={filters.moduleLocation} onChange={e=>setFilters({...filters, moduleLocation: e.target.value})} className="w-full p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm dark:text-white">
                                        <option value="">Todos</option>
                                        {LOCATION_OPTIONS.map(l => <option key={l} value={l}>{l}</option>)}
                                    </select>
                                </div>
                                <div className="flex gap-2 pt-2"><button onClick={() => setFilters({startDate:'', endDate:'', type:'', responsible:'', moduleLocation:''})} className="flex-1 py-1 text-xs font-bold text-gray-500 bg-gray-200 dark:bg-gray-700 rounded">Limpar</button><button onClick={() => setShowFilter(false)} className="flex-1 py-1 text-xs font-bold text-white bg-brand-red rounded">Fechar</button></div>
                            </div>
                        </div>
                    )}
                    
                    {!showBin && (
                        <div className="bg-gray-100 dark:bg-gray-900 p-3 border-b border-gray-200 dark:border-gray-700 sticky top-[72px] z-10">
                            <div className="relative">
                                 <select value={viewMonth} onChange={(e) => setViewMonth(e.target.value)} className="w-full p-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-white font-bold appearance-none cursor-pointer uppercase text-center">
                                    {availableMonths.map(month => <option key={month} value={month}>{formatMonthDisplay(month).toUpperCase()}</option>)}
                                </select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500"><i className="fas fa-calendar-alt"></i></div>
                            </div>
                        </div>
                    )}

                    <div className="flex-1 overflow-y-auto p-3 space-y-3">
                        {displayList.length === 0 && <div className="text-center text-gray-500 mt-10">{showBin ? "Lixeira vazia." : `Nenhum registro em ${formatMonthDisplay(viewMonth)}.`}</div>}
                        
                        {showBin ? (
                            displayList.map(item => renderItem(item))
                        ) : (
                            <>
                                {groupedData.EXTINTOR.length > 0 && (
                                    <div className="mb-2">
                                        <button 
                                            onClick={() => toggleSection('EXTINTOR')}
                                            className="w-full flex justify-between items-center bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border-l-4 border-brand-red transition-all active:scale-[0.99]"
                                        >
                                            <span className="font-bold text-brand-red flex items-center gap-2 uppercase tracking-wide">
                                                <i className="fas fa-fire-extinguisher"></i> EXTINTORES ({groupedData.EXTINTOR.length})
                                            </span>
                                            <i className={`fas fa-chevron-${expandedSections['EXTINTOR'] ? 'up' : 'down'} text-gray-400`}></i>
                                        </button>
                                        
                                        {expandedSections['EXTINTOR'] && (
                                            <div className="mt-2 space-y-3 pl-2 border-l-2 border-gray-200 dark:border-gray-700 ml-4 animate-fade-in">
                                                {groupedData.EXTINTOR.map(item => renderItem(item))}
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {groupedData.HIDRANTE.length > 0 && (
                                    <div className="mb-2">
                                        <button 
                                            onClick={() => toggleSection('HIDRANTE')}
                                            className="w-full flex justify-between items-center bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border-l-4 border-brand-orange transition-all active:scale-[0.99]"
                                        >
                                            <span className="font-bold text-brand-orange flex items-center gap-2 uppercase tracking-wide">
                                                <i className="fas fa-faucet"></i> HIDRANTES ({groupedData.HIDRANTE.length})
                                            </span>
                                            <i className={`fas fa-chevron-${expandedSections['HIDRANTE'] ? 'up' : 'down'} text-gray-400`}></i>
                                        </button>
                                        
                                        {expandedSections['HIDRANTE'] && (
                                            <div className="mt-2 space-y-3 pl-2 border-l-2 border-gray-200 dark:border-gray-700 ml-4 animate-fade-in">
                                                {groupedData.HIDRANTE.map(item => renderItem(item))}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {groupedData.RONDA.length > 0 && (
                                    <div className="mb-2">
                                        <button 
                                            onClick={() => toggleSection('RONDA')}
                                            className="w-full flex justify-between items-center bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border-l-4 border-brand-blue transition-all active:scale-[0.99]"
                                        >
                                            <span className="font-bold text-brand-blue flex items-center gap-2 uppercase tracking-wide">
                                                <i className="fas fa-clipboard-check"></i> RONDAS PREV. ({groupedData.RONDA.length})
                                            </span>
                                            <i className={`fas fa-chevron-${expandedSections['RONDA'] ? 'up' : 'down'} text-gray-400`}></i>
                                        </button>
                                        
                                        {expandedSections['RONDA'] && (
                                            <div className="mt-2 space-y-3 pl-2 border-l-2 border-gray-200 dark:border-gray-700 ml-4 animate-fade-in">
                                                {groupedData.RONDA.map(item => renderItem(item))}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            // Inicializa estado com dados do localStorage, se existirem
            const [page, setPage] = useState(localStorage.getItem('trfire_user') ? 'menu' : 'responsible');
            const [responsible, setResponsible] = useState(localStorage.getItem('trfire_user') || '');
            
            const [inspectionType, setInspectionType] = useState('EXTINTOR');
            const [roundLocation, setRoundLocation] = useState(''); // Novo estado para local de ronda
            // Estado inicial vazio, será preenchido pelo Firebase
            const [db, setDb] = useState([]);
            const [users, setUsers] = useState([]); // Lista de usuários vinda do BD
            const [scanRes, setScanRes] = useState(null);
            
            // Estado de Notificação
            const [notification, setNotification] = useState({ isOpen: false, message: '', type: 'info', isConfirmation: false, onConfirm: null });

            const showAlert = (message, type = 'info') => {
                setNotification({ isOpen: true, message, type, isConfirmation: false, onConfirm: null });
            };

            const showConfirm = (message, onConfirmAction, type = 'warning') => {
                setNotification({ isOpen: true, message, type, isConfirmation: true, onConfirm: onConfirmAction });
            };

            const closeNotification = () => setNotification({ ...notification, isOpen: false });
            
            // EFEITO PARA SINCRONIZAR COM FIREBASE (INSPEÇÕES + USUÁRIOS)
            useEffect(() => {
                if(!dbFirestore) return;

                // 1. Monitorar Inspeções
                const q = query(collection(dbFirestore, "inspections"), orderBy("created_at", "desc"));
                const unsubscribeInspections = onSnapshot(q, (querySnapshot) => {
                    const inspections = [];
                    querySnapshot.forEach((doc) => {
                        inspections.push({ id: doc.id, ...doc.data() });
                    });
                    setDb(inspections);
                }, (error) => {
                    console.error("Erro ao buscar dados:", error);
                });

                // 2. Monitorar Usuários (Migração Inicial se necessário)
                const usersCollection = collection(dbFirestore, "users");
                const qUsers = query(usersCollection, orderBy("name"));
                
                const unsubscribeUsers = onSnapshot(qUsers, async (snapshot) => {
                    const usersList = [];
                    snapshot.forEach(doc => usersList.push({ id: doc.id, ...doc.data() }));
                    
                    setUsers(usersList);
                });

                return () => {
                    unsubscribeInspections();
                    unsubscribeUsers();
                };
            }, []);
            
            const handleStartInspection = (type) => { setInspectionType(type); setPage('scan'); };

            const handleRoundStart = (location) => {
                setRoundLocation(location);
                setInspectionType('RONDA');
                setPage('scan');
            };
            
            // SALVAR NO FIREBASE (INSPEÇÃO)
            const handleSave = async (formData) => {
                if(!dbFirestore) {
                    showAlert("Erro: Banco de dados não conectado. Verifique a configuração.", "error");
                    return;
                }
                try {
                    await addDoc(collection(dbFirestore, "inspections"), formData);
                    setPage('list');
                } catch (e) {
                    console.error("Erro ao salvar: ", e);
                    showAlert("Erro ao salvar na nuvem. Verifique sua conexão. (Se a foto for muito grande, o Firestore pode rejeitar)", "error");
                }
            };

            // SALVAR NO FIREBASE (NOVO USUÁRIO)
            const handleSaveUser = async (userData) => {
                if(!dbFirestore) return;
                try {
                    await addDoc(collection(dbFirestore, "users"), userData);
                } catch(e) {
                    console.error("Erro ao salvar usuário", e);
                    showAlert("Erro ao salvar usuário.", "error");
                }
            };

            // ATUALIZAR USUÁRIO (SENHA)
            const handleUpdateUser = async (id, newPass) => {
                if(!dbFirestore) return;
                try {
                    await updateDoc(doc(dbFirestore, "users", id), { pass: newPass });
                    showAlert("Senha atualizada com sucesso!", "success");
                } catch(e) {
                    console.error("Erro ao atualizar usuário", e);
                    showAlert("Erro ao atualizar senha.", "error");
                }
            };

            // EXCLUIR USUÁRIO
            const handleDeleteUser = async (id) => {
                if(!dbFirestore) return;
                try {
                    await deleteDoc(doc(dbFirestore, "users", id));
                    showAlert("Usuário excluído com sucesso!", "success");
                } catch(e) {
                    console.error("Erro ao excluir usuário", e);
                    showAlert("Erro ao excluir usuário.", "error");
                }
            };

            // IMPORTAR DADOS (Restaurar Backup)
            const handleImportData = async (jsonData) => {
                if(!dbFirestore) return showAlert("Erro de conexão com o banco de dados.", "error");
                if(!Array.isArray(jsonData)) return showAlert("Arquivo inválido. O formato deve ser uma lista JSON.", "error");
                
                showConfirm(
                    `⚠️ ATENÇÃO: Você está prestes a importar ${jsonData.length} registros.\n\nIsso pode sobrescrever dados existentes se os IDs coincidirem.\nDeseja continuar?`,
                    async () => {
                        let successCount = 0;
                        let errorCount = 0;

                        // Loop simples para processar a importação
                        for (const item of jsonData) {
                            try {
                                if (item.id) {
                                    // Se tem ID, usa setDoc para restaurar exatamente aquele documento (atualiza ou cria)
                                    const { id, ...dataToSave } = item;
                                    const docRef = doc(dbFirestore, "inspections", id);
                                    await setDoc(docRef, dataToSave);
                                } else {
                                    // Se não tem ID, cria um novo
                                    await addDoc(collection(dbFirestore, "inspections"), item);
                                }
                                successCount++;
                            } catch (e) {
                                console.error("Erro ao importar item:", item, e);
                                errorCount++;
                            }
                        }
                        showAlert(`Importação concluída!\n✅ Sucesso: ${successCount}\n❌ Erros: ${errorCount}`, "success");
                    },
                    "warning"
                );
            };

            // ATUALIZAR (DELETAR/RESTAURAR) NO FIREBASE
            const handleToggleDelete = async (id, status) => {
                if(!dbFirestore) return;
                try {
                    const docRef = doc(dbFirestore, "inspections", id);
                    await updateDoc(docRef, { deleted: status });
                } catch (e) {
                    console.error("Erro ao atualizar: ", e);
                    showAlert("Erro ao atualizar registro.", "error");
                }
            };

            // EXCLUIR DEFINITIVAMENTE DO FIREBASE
            const handleDeletePermanently = async (id) => {
                if(!dbFirestore) return;
                try {
                    await deleteDoc(doc(dbFirestore, "inspections", id));
                } catch (e) {
                    console.error("Erro ao excluir permanentemente: ", e);
                    showAlert("Erro ao excluir do banco de dados.", "error");
                }
            };

            const handleLogin = (name) => {
                localStorage.setItem('trfire_user', name);
                setResponsible(name);
                setPage('menu');
            };

            return (
                <>
                    <NotificationModal 
                        isOpen={notification.isOpen} 
                        message={notification.message} 
                        type={notification.type} 
                        isConfirmation={notification.isConfirmation}
                        onClose={closeNotification}
                        onConfirm={notification.onConfirm}
                    />

                    {page === 'responsible' && <ResponsibleScreen onConfirm={handleLogin} usersList={users} showAlert={showAlert} />}
                    {page === 'menu' && <MenuScreen onNavigate={setPage} responsibleName={responsible} onStartInspection={handleStartInspection} />}
                    {page === 'roundsLocation' && <RoundsLocationScreen onNavigate={setPage} onSelectLocation={handleRoundStart} />}
                    {page === 'userRegister' && <UserRegisterScreen onNavigate={setPage} onSaveUser={handleSaveUser} usersList={users} onUpdateUser={handleUpdateUser} onDeleteUser={handleDeleteUser} showAlert={showAlert} showConfirm={showConfirm} />}
                    {page === 'scan' && <ScannerScreen onNavigate={(target) => setPage(target === 'menu' && inspectionType === 'RONDA' ? 'roundsLocation' : target)} onScanSuccess={(d)=>{setScanRes(d); setPage(inspectionType === 'RONDA' ? 'roundsForm' : 'form')}} db={db} inspectionType={inspectionType} showAlert={showAlert} />}
                    {page === 'form' && <FormScreen initialData={scanRes} onNavigate={setPage} responsibleName={responsible} inspectionType={inspectionType} onSave={handleSave} showAlert={showAlert} />}
                    {page === 'roundsForm' && <RoundsFormScreen initialData={scanRes} onNavigate={setPage} responsibleName={responsible} roundLocation={roundLocation} onSave={handleSave} showAlert={showAlert} />}
                    {page === 'list' && <ListScreen data={db} onNavigate={setPage} onToggleDelete={handleToggleDelete} onDeletePermanently={handleDeletePermanently} onImportData={handleImportData} currentUser={responsible} showAlert={showAlert} showConfirm={showConfirm} />}
                </>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
